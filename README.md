基于消息的控制器框架
============================
> 目录
<!-- TOC -->

- [1. 依赖](#1-依赖)
- [2. 编译](#2-编译)
    - [2.1. 编译命令](#21-编译命令)
- [3. 数据包格式](#3-数据包格式)
    - [3.1. api发送命令](#31-api发送命令)
    - [3.2. api接收消息](#32-api接收消息)

<!-- /TOC -->

## 
# 1. 依赖
1. 当前框架需要zmq和jsoncpp,当前提供了zmq和jsoncpp的x86与arm的库文件,采用g++4.8编译如若需要其他版本库,下载如下代码自行编译替换即可
    - zmq消息框架,下载地址:https://github.com/zeromq/libzmq
    - jsoncpp,下载地址:https://github.com/open-source-parsers/jsoncpp

##
# 2. 编译
1. 控制器在不同的平台上，采用不同的编译配置

## 2.1. 编译命令
1. x86-linux
    - mkdir build ; cd build;
    - cmake .. 

2. x86-windows 
   
3. cross-arm-linux
    - mkdir build ; cd build ;
    - cmake .. -DCMAKE_TOOLCHAIN_FILE=../cross-arm-linux-gnueabihf.cmake 

##
# 3. 数据包格式
## 3.1. api发送命令
```json
{
    "msgType": 0,
    "module" : 0,
    "needReply":true,
    "msgData":
    {
        "cmd": 0,
        "params":
        {
            "param1": "string",
            "param2": 123,
            "...":
        }
    }
}
```
- msgType:0-1
    - 0表示该消息为命令消息
    - 1表示该消息为状态消息
-  module:0-n
    - 等于stateBase中定义的msgModule_t对应的枚举值
- needReply:true/false
    - true表示该消息需要返回
    - false表示该消息无需返回
- cmd
    - 对应模块的命令号
- params:参数
## 3.2 api接收消息
```json
{
    "replyMessage":
    {
        "param1":"xx",
        "param2":"xx",
        "..."
    }
}
```


motion 
- kdl
    - 获取配置参数(轴的个数,dh参数,夹具信息等)
        - 机械臂型号(scara,delta,ur),对应的D-H参数
    - 机械臂正/逆解
        - 正解是已知各轴关节值根据D-H参数生成变化矩阵,而后矩阵相乘,采用库方法(orocos)求出末端姿态
        - 逆解是已知设备末端姿态解线性方程得出各轴关节值的过程,采用通用方法求解时间长且不可靠,需要对不同的设备型号求解
    - 动力学
        - 根据设备当前的位姿以及运动状态,求出各轴所需力矩
        - 根据设备当前状态和各轴力矩推算下一时刻设备的运动状态和位姿
    - 夹具
        - 支持设置夹具以及移除夹具,以此衍生出正逆解带夹具的函数接口
- 速度规划
    - 梯形速度规划,速度的变化曲线为梯形,加速度不连续,加加速度突变,按照该规划加速用时短,但存在冲击
    - 五次多项式s速度规划,采用五次多项式替换梯形速度规划的加减速区,加速度连续,加加速度部分连续,该规划能较好的控制插补带来的冲击\
    但是无法再变速过程中实时变速,当加速度较小时则存在变速无响应的问题
    - 七段式s速度规划,采用抛物线链接梯形速度规划的变速区,加速度连续,加加速度不连续,按照该规划可以较好的调控速度变化
- 算法库(输入输出关系明确,与系统状态配置无关)
    - 标定参考坐标系
        - 设备末端多点定参考坐标系
        - 视觉参考坐标系标定
    - 标定夹具参数
        - 夹具参考坐标系校验
    - 样条曲线求值
    - 几何判定(点是否在直线/圆弧上等)
    - 设备精度校验
        - 指定设备精度校验(左右臂切换校验姿态精度)
- 运动队列
    - 运动的增删改查
- motion运动规划 
    - 安全
    - 获取配置参数
        - 配置各轴的运动参数(速度/加速度等)
        - 配置设备的dh参数(臂长等等)
        - 配置设备的动力学参数
        - 配置设备的软硬限位
    - 添加点到点/直线/圆弧/样条
        - 根据给定参数生成速度规划参数(路程,速度,加速度等),添加至运动队列中
        - 对于空间运动则前瞻计算衔接速度(与速度规划相关)
        - 几何过渡则需要插入一段运动
        - (一键回原点)
    - 暂停/继续/停止/调速
        - 暂停设置速度为0
        - 继续恢复之前速度
        - 停止设置速度为0并清空运动队列
        - 调速/(百分比)/(mm/s)/(rad/s)
    - 同步位置
        - 添加运动前需要同步各轴位置
        - 电机状态有改变则清空队列
    - 钩子函数(调用反回插补的关节值)
        - 运动队列获取/移除
        - 速度规划得到进给步长
        - 进给步长映射至对应运动类型(直线/圆弧等,该步骤耗时最长)
        - 逆解输出各轴关节值
        - (待定:提前计算/提前计算所有值存于队列中,改变速度时则把当前值传入重新规划)

- 模块返回消息格式示例
```json
{
    "stateMsg":
    {
        "state":"xx",
        "value":"xx",
        "..."
    },
    "resultMsg":
    {
        "param1":"xx",
        "param2":"xx",
        "..."
    }
}
```
- 执行后返回消息格式示例
```json
{
    "needReply":"xx",
    "replyMessage":
    {
        "param1":"xx",
        "param2":"xx",
        "..."
    }
}
```
